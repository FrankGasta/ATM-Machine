#include <iostream>
#include <fstream>
#include <conio.h>
#include <windows.h>
#include <string>
#include <ctime>
#include <cstdlib>

using namespace std;

class Registration {
private:
    string RegisterAccNumber();
    void EncryptPIN(string &pin);
    bool FileExists(const string &filename);

public:
    void Register();
};

class Transaction {
private:
    string accNumber;
    int balance;

    int withdraw_checker(int amount, int balance);
    int withdraw_calc(int balance, int withdraw);
    int deposit_checker(int amount);
    int deposit_calc(int balance, int deposit);
    void updateAccount();

public:
    void setAccountNumber(const string &accNo);
    bool loadAccount(const string &accNumber);  
    void transaction_menu();
    void displayBalance();
    void transaction_withdraw();
    void transaction_deposit();
};

string Registration::RegisterAccNumber() {
    srand(time(0));
    string accNumber;
    do {
        accNumber = to_string(rand() % 900000 + 100000); 
    } while (FileExists("account_" + accNumber + ".txt"));
    return accNumber;
}

void Registration::EncryptPIN(string &pin) {
    for (char &c : pin) c += 3; 
}

bool Registration::FileExists(const string &filename) {
    ifstream file(filename);
    return file.good();  
}

void Registration::Register() {
    string name, bday, contact, pin;
    const int deposit = 5000;

    system("cls");
    string accNumber = RegisterAccNumber();
    cout << "Generated Account Number: " << accNumber << endl;

    cout << "Enter Account Name: ";
    cin.ignore();
    getline(cin, name);

    cout << "Enter Birthday (YYYY-MM-DD): ";
    cin >> bday;

    cout << "Enter Contact Number: ";
    cin >> contact;

    cout << "Enter a 4-digit PIN Code: ";
    pin = "";
    while (pin.length() < 4) {
        char ch = _getch();
        if (isdigit(ch)) {
            pin += ch;
            cout << '*';
        }
    }
    cout << endl;

    EncryptPIN(pin);

    ofstream outfile("account_" + accNumber + ".txt");
    outfile << accNumber << endl
            << name << endl
            << bday << endl
            << contact << endl
            << deposit << endl
            << pin << endl;
    outfile.close();

    cout << "Account successfully registered!" << endl;
    cout << "Press any key to return to the menu..." << endl;
    _getch(); 
}

void Transaction::setAccountNumber(const string &accNo) {
    accNumber = accNo;
}

bool Transaction::loadAccount(const string &accNumber) {
    ifstream infile("account_" + accNumber + ".txt");
    if (infile.is_open()) {
        string accName, bday, contact, pin;
        infile >> this->accNumber >> accName >> bday >> contact >> balance >> pin;  
        infile.close();
        return true;
    } else {
        cout << "Account not found!" << endl;
        return false; 
    }
}

void Transaction::updateAccount() {
    ofstream outfile("account_" + accNumber + ".txt");
    if (outfile.is_open()) {
        outfile << accNumber << endl
                << "Placeholder Name" << endl 
                << "Placeholder Bday" << endl
                << "Placeholder Contact" << endl
                << balance << endl
                << "Placeholder Encrypted PIN" << endl;
        outfile.close();
    }
}

void Transaction::transaction_menu() {
    int pointer = 0;
    const char ENTER = 13;
    string transactionMenu[4] = {"Balance Inquiry", "Withdraw", "Deposit", "Exit"};

    while (true) {
        system("cls");
        cout << "TRANSACTION MENU" << endl << endl;

        for (int i = 0; i < 4; ++i) {
            if (i == pointer) {
                cout << "> " << transactionMenu[i] << endl; 
            } else {
                cout << "  " << transactionMenu[i] << endl;
            }
        }

        char ch = _getch();

        if (ch == VK_UP) {
            pointer = (pointer - 1 + 4) % 4; 
        } else if (ch == VK_DOWN) {
            pointer = (pointer + 1) % 4; 
        } else if (ch == ENTER) {
            switch (pointer) {
                case 0:
                    displayBalance();
                    break;
                case 1:
                    transaction_withdraw();
                    break;
                case 2:
                    transaction_deposit();
                    break;
                case 3:
                    return; 
            }
        }
    }
}

void Transaction::displayBalance() {
    cout << "========= Balance =========" << endl;
    cout << "Amount: Php. " << balance << ".00" << endl;
    cout << "Press any key to continue..." << endl;
    _getch();
}

void Transaction::transaction_withdraw() {
    int inputAmount;

    cout << "======== Withdraw ========" << endl;
    cout << "Input Amount: Php. ";
    cin >> inputAmount;

    if (inputAmount > balance) {
        cout << "Insufficient balance." << endl;
    } else {
        balance -= inputAmount;
        updateAccount();
        cout << "Withdrawal successful. New balance: Php. " << balance << ".00" << endl;
    }

    cout << "Press any key to continue..." << endl;
    _getch();
}

void Transaction::transaction_deposit() {
    int inputAmount;

    cout << "=========== Deposit ============" << endl;
    cout << "Input Amount: Php. ";
    cin >> inputAmount;

    balance += inputAmount;
    updateAccount();

    cout << "Deposit successful. New balance: Php. " << balance << ".00" << endl;

    cout << "Press any key to continue..." << endl;
    _getch();
}

int main() {
    Registration reg;
    Transaction trans;

    while (true) { 
        int option;

        system("cls");
        cout << "1. Register Account\n2. Transaction Menu\nSelect Option: ";
        cin >> option;

        if (option == 1) {
            reg.Register();
        } else if (option == 2) {
            string accNumber;
            cout << "Enter Account Number: ";
            cin >> accNumber;
            trans.setAccountNumber(accNumber);
            if (trans.loadAccount(accNumber)) { 
                trans.transaction_menu();
            }
        } else {
            cout << "Invalid option. Please select again." << endl;
        }
    }

    return 0;
}
